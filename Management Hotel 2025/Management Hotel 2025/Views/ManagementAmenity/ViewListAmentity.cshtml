@model IEnumerable<Management_Hotel_2025.Modules.AmentityModules.AmentityServices.MyAmenity>

@{
    Layout = "~/Views/Shared/AdminSidebar.cshtml";
    ViewBag.Title = "Danh sách tiện ích";
}

@section Styles {
    <style>
        /* Theme variables */
        :root {
            --accent-start: #7b3fe4; /* tím đậm */
            --accent-end: #ff6b6b; /* đỏ hồng */
            --accent-contrast: #fff;
            --card-bg: rgba(255,255,255,0.04);
        }

        /* Header / Title block */
        .utilities-header {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            color: var(--accent-contrast);
            box-shadow: 0 6px 20px rgba(123,63,228,0.18);
            margin-bottom: 1.25rem;
        }

            .utilities-header .left {
                display: flex;
                gap: 12px;
                align-items: center;
                min-width: 0;
            }

            .utilities-header .icon-wrap {
                width: 64px;
                height: 64px;
                border-radius: 12px;
                background: rgba(255,255,255,0.12);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                flex-shrink: 0;
                box-shadow: 0 4px 10px rgba(0,0,0,0.12) inset;
            }

            .utilities-header h2 {
                margin: 0;
                font-size: 22px;
                font-weight: 700;
                line-height: 1;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }

            .utilities-header .subtitle {
                display: block;
                font-size: 13px;
                opacity: 0.95;
                margin-top: 3px;
                color: rgba(255,255,255,0.92);
                font-weight: 500;
            }

        /* Right group: search box */
        .utilities-search {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .utilities-search .input-group {
                max-width: 520px;
                box-shadow: 0 6px 18px rgba(11,15,30,0.06);
                border-radius: 8px;
                overflow: hidden;
            }

            /* Nút tạo tiện ích - loại bỏ gạch chân mặc định của <a> */
            .utilities-search .create-btn {
                white-space: nowrap;
                border-radius: 8px;
                padding: 8px 12px;
                background: #fff;
                color: #4a2fcf;
                border: none;
                box-shadow: 0 4px 12px rgba(74,47,207,0.12);
                display: inline-flex;
                align-items: center;
                gap: 8px;
                text-decoration: none !important; /* loại bỏ gạch chân */
            }

                .utilities-search .create-btn:hover,
                .utilities-search .create-btn:focus {
                    text-decoration: none !important;
                    transform: translateY(-1px);
                    cursor: pointer;
                    box-shadow: 0 6px 16px rgba(74,47,207,0.16);
                }

                .utilities-search .create-btn i {
                    font-size: 16px;
                    line-height: 1;
                }

        /* Table card */
        .utilities-card {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 8px 28px rgba(11,15,30,0.04);
            backdrop-filter: blur(6px);
        }

        /* Small responsive tweaks */
        @@media (max-width: 768px) {
            .utilities-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

                .utilities-header .left {
                    gap: 10px;
                }

                .utilities-header .icon-wrap {
                    width: 56px;
                    height: 56px;
                }

            .utilities-search {
                flex-direction: column;
                align-items: stretch;
            }

                .utilities-search .input-group {
                    max-width: 100%;
                }

                .utilities-search .create-btn {
                    width: 100%;
                    justify-content: center;
                }
        }

        table th, table td {
            vertical-align: middle !important;
        }

        /* Modal chung */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }

            .custom-modal.active {
                display: flex;
            }

            .custom-modal .modal-content {
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                max-width: 400px;
                width: 90%;
                text-align: center;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }

                .custom-modal .modal-content h5 {
                    margin-bottom: 20px;
                    font-size: 18px;
                    font-weight: 600;
                }

            .custom-modal .modal-buttons {
                display: flex;
                justify-content: space-around;
                gap: 10px;
            }

                .custom-modal .modal-buttons button {
                    flex: 1;
                    padding: 8px 12px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    border: none;
                }

            .custom-modal .btn-confirm {
                background: var(--accent-start);
                color: #fff;
            }

            .custom-modal .btn-cancel {
                background: #ccc;
                color: #333;
            }

        /* Toast */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            min-width: 200px;
            margin-top: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0.95;
        }

        .toast-success {
            background-color: #28a745;
        }

        .toast-error {
            background-color: #dc3545;
        }

        /* Loader mới */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loader {
            width: 44.8px;
            height: 44.8px;
            color: #554cb5;
            position: relative;
            background: radial-gradient(11.2px,currentColor 94%,#0000);
        }

            .loader:before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: 50%;
                background: radial-gradient(10.08px at bottom right,#0000 94%,currentColor) top left, radial-gradient(10.08px at bottom left,#0000 94%,currentColor) top right, radial-gradient(10.08px at top right,#0000 94%,currentColor) bottom left, radial-gradient(10.08px at top left,#0000 94%,currentColor) bottom right;
                background-size: 22.4px 22.4px;
                background-repeat: no-repeat;
                animation: loader 1.5s infinite cubic-bezier(0.3,1,0,1);
            }

        @@keyframes loader {
            33% {
                inset: -11.2px;
                transform: rotate(0deg);
            }

            66% {
                inset: -11.2px;
                transform: rotate(90deg);
            }

            100% {
                inset: 0;
                transform: rotate(90deg);
            }
        }
    </style>
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container-fluid">
    <div class="utilities-header">
        <div class="left">
            <div class="icon-wrap">
                <i class="bi bi-box-seam" aria-hidden="true" style="font-size:22px;color:var(--accent-contrast)"></i>
            </div>
            <div class="title-wrap">
                <h2>Quản lý tiện ích</h2>
                <span class="subtitle">Xem, chỉnh sửa và quản trị các tiện ích phòng — dễ dàng và trực quan.</span>
            </div>
        </div>

        <div class="utilities-search ms-auto">
            <div class="input-group">
                <input id="searchInput" type="text" class="form-control" placeholder="Tìm theo tên..." aria-label="Tìm theo tên" />
                <button id="clearSearch" class="btn btn-outline-light" type="button">Xóa</button>
            </div>

            <!-- Nút tạo tiện ích (gạch chân đã bị loại bỏ bằng CSS) -->
            <a id="createAmenityBtn" class="create-btn" asp-controller="ManagementAmenity" asp-action="ViewCreateAmentity" title="Tạo tiện ích mới" target="_blank" role="button">
                <i class="bi bi-plus-lg" aria-hidden="true" style="font-size:16px;"></i>
                <span>Tạo mới tiện ích</span>
            </a>
        </div>
    </div>

    <div class="utilities-card">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="utilitiesTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:60px">STT</th>
                        <th>Tên</th>
                        <th style="width:140px">Trạng thái</th>
                        <th style="width:160px">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        var idx = 1;
                        foreach (var item in Model)
                        {
                            var visible = item.Status == "Active";
                            var badgeClass = visible ? "bg-success" : "bg-secondary";
                            var badgeText = visible ? "Hiển thị" : "Đang ẩn";
                            <tr data-name="@item.Name.ToLowerInvariant()" data-id="@item.AmenityId" data-visible="@visible.ToString().ToLowerInvariant()">
                                <td>@idx</td>
                                <td class="util-name">@item.Name</td>
                                <td>
                                    <span class="badge @badgeClass util-status">@badgeText</span>
                                </td>
                                <td>
                                    <a class="btn btn-sm btn-outline-primary me-2" 
                                       href="@Url.Action("ViewUpdateAmentity", "ManagementAmenity", new { id = item.AmenityId })"
                                       title="Chỉnh sửa">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>

                                    <button class="btn btn-sm btn-outline-secondary me-2 toggle-visibility"
                                            title="@(visible ? "Ẩn tiện ích" : "Hiện tiện ích")">
                                        <i class="bi @(visible ? "bi-eye" : "bi-eye-slash")"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-danger delete-amenity" data-id="@item.AmenityId" title="Xóa">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            idx++;
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="text-center text-muted">Không có tiện ích nào.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="customModal" class="custom-modal">
    <div class="modal-content">
        <h5 id="modalMessage">Bạn có chắc?</h5>
        <div class="modal-buttons">
            <button id="modalConfirm" class="btn-confirm">Đồng ý</button>
            <button id="modalCancel" class="btn-cancel">Hủy</button>
        </div>
    </div>
</div>

<!-- Loader overlay mới -->
<div id="loadingOverlay">
    <div class="loader"></div>
</div>

<!-- Toast container -->
<div id="toastContainer"></div>

@section Scripts {
    <script>
        const modal = document.getElementById("customModal");
        const modalMessage = document.getElementById("modalMessage");
        const modalConfirm = document.getElementById("modalConfirm");
        const modalCancel = document.getElementById("modalCancel");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const toastContainer = document.getElementById("toastContainer");

        let currentAction = null;
        let currentId = null;

        function showLoading() { loadingOverlay.style.display = "flex"; }
        function hideLoading() { loadingOverlay.style.display = "none"; }

        function showToast(message, type="success") {
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        // Bắt sự kiện click trên Delete / Toggle
        document.addEventListener("click", function(e) {
            const deleteBtn = e.target.closest(".delete-amenity");
            const toggleBtn = e.target.closest(".toggle-visibility");

            if (deleteBtn) {
                currentAction = "delete";
                currentId = deleteBtn.getAttribute("data-id");
                modalMessage.textContent = "Bạn có chắc muốn xóa tiện ích này không?";
                modal.classList.add("active");
            }

            if (toggleBtn) {
                currentAction = "toggle";
                const tr = toggleBtn.closest("tr");
                currentId = tr.getAttribute("data-id");
                const visible = tr.getAttribute("data-visible") === "true";
                modalMessage.textContent = visible ? "Bạn có muốn ẩn tiện ích này không?" : "Bạn có muốn hiển thị tiện ích này không?";
                modal.classList.add("active");
            }
        });

        modalCancel.addEventListener("click", function() {
            modal.classList.remove("active");
            currentAction = null;
            currentId = null;
        });

        modalConfirm.addEventListener("click", function() {
            if (!currentAction || !currentId) return;
            showLoading();

            let url = `/admin/amenity/${currentId}`;
            let method = currentAction === "delete" ? "DELETE" : "PATCH";

            fetch(url, { method })
                .then(response => {
                    hideLoading();
                    if(response.ok) {
                        showToast(
                            currentAction === "delete" ? "Xóa tiện ích thành công!" : "Cập nhật trạng thái thành công!",
                            "success"
                        );
                        // reload trang sau khi thành công
                        setTimeout(() => location.reload(), 800);
                    } else {
                        showToast(
                            currentAction === "delete" ? "Xóa thất bại!" : "Cập nhật thất bại!",
                            "error"
                        );
                    }
                })
                .catch(() => {
                    hideLoading();
                    showToast("Có lỗi xảy ra!", "error");
                });

            modal.classList.remove("active");
            currentAction = null;
            currentId = null;
        });

        // Xóa text input search
        document.getElementById("clearSearch").addEventListener("click", function () {
            document.getElementById("searchInput").value = "";
        });
    </script>
}