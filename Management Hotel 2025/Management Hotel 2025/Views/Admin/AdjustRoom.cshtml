@model Management_Hotel_2025.ViewModel.AdJustRoom

@{
    Layout = "~/Views/Shared/AdminSidebar.cshtml";
    ViewData["Title"] = "Chỉnh sửa phòng";
}

@section Styles {
    <style>
                .image-thumbnail-container {
                        position: relative;
                        width: 100%;
                        padding-top: 100%;
                        overflow: hidden;
                        border-radius: 0.375rem;
                        border: 1px solid #dee2e6;

        }

                    .image-thumbnail-container img {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            object-fit: cover;

        }

                .btn-delete-image {
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        z-index: 10;
                        background-color: rgba(255, 255, 255, 0.7);

        }


        /* Toast góc phải trên */
                .toast-top-right {
                        position: fixed;
                        top: 1rem;
                        right: -300px;
                        padding: 1rem 2rem;
                        border-radius: 0.5rem;
                        font-size: 1.1rem;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        z-index: 1050;
                        opacity: 0;
                        color: white;
                        transition: right 0.5s ease, opacity 0.5s ease;

        }

                    .toast-top-right.show {
                            right: 1rem;
                            opacity: 1;

        }


        /* Thành công */
                #successToast {
                        background-color: #28a745;

        }


        /* Thất bại */
                #errorToast {
                        background-color: #dc3545;

        }


        /* Loading overlay */
                .loading-overlay {
                        position: fixed;
                        inset: 0;
                        background: rgba(0,0,0,0.45);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        z-index: 2000;

        }

                    .loading-overlay.active {
                            display: flex;

        }


        /* Optional: slightly increase hamster z-index so it's above overlay background shadow if needed */
                .wheel-and-hamster {
                        z-index: 2001;

        }


        /* ---------- hamster CSS (original provided) ---------- */
                .wheel-and-hamster {
                        --dur: 1s;
                        position: relative;
                        width: 12em;
                        height: 12em;
                        font-size: 14px;

        }

                .wheel,
                .hamster,
                .hamster div,
                .spoke {
                        position: absolute;

        }

                .wheel,
                .spoke {
                        border-radius: 50%;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;

        }

                .wheel {
                        background: radial-gradient(100% 100% at center,hsla(0,0%,60%,0) 47.8%,hsl(0,0%,60%) 48%);
                        z-index: 2;

        }

                .hamster {
                        animation: hamster var(--dur) ease-in-out infinite;
                        top: 50%;
                        left: calc(50% - 3.5em);
                        width: 7em;
                        height: 3.75em;
                        transform: rotate(4deg) translate(-0.8em,1.85em);
                        transform-origin: 50% 0;
                        z-index: 1;

        }

                .hamster__head {
                        animation: hamsterHead var(--dur) ease-in-out infinite;
                        background: hsl(30,90%,55%);
                        border-radius: 70% 30% 0 100% / 40% 25% 25% 60%;
                        box-shadow: 0 -0.25em 0 hsl(30,90%,80%) inset, 0.75em -1.55em 0 hsl(30,90%,90%) inset;
                        top: 0;
                        left: -2em;
                        width: 2.75em;
                        height: 2.5em;
                        transform-origin: 100% 50%;

        }

                .hamster__ear {
                        animation: hamsterEar var(--dur) ease-in-out infinite;
                        background: hsl(0,90%,85%);
                        border-radius: 50%;
                        box-shadow: -0.25em 0 hsl(30,90%,55%) inset;
                        top: -0.25em;
                        right: -0.25em;
                        width: 0.75em;
                        height: 0.75em;
                        transform-origin: 50% 75%;

        }

                .hamster__eye {
                        animation: hamsterEye var(--dur) linear infinite;
                        background-color: hsl(0,0%,0%);
                        border-radius: 50%;
                        top: 0.375em;
                        left: 1.25em;
                        width: 0.5em;
                        height: 0.5em;

        }

                .hamster__nose {
                        background: hsl(0,90%,75%);
                        border-radius: 35% 65% 85% 15% / 70% 50% 50% 30%;
                        top: 0.75em;
                        left: 0;
                        width: 0.2em;
                        height: 0.25em;

        }

                .hamster__body {
                        animation: hamsterBody var(--dur) ease-in-out infinite;
                        background: hsl(30,90%,90%);
                        border-radius: 50% 30% 50% 30% / 15% 60% 40% 40%;
                        box-shadow: 0.1em 0.75em 0 hsl(30,90%,55%) inset, 0.15em -0.5em 0 hsl(30,90%,80%) inset;
                        top: 0.25em;
                        left: 2em;
                        width: 4.5em;
                        height: 3em;
                        transform-origin: 17% 50%;
                        transform-style: preserve-3d;

        }

                .hamster__limb--fr,
                .hamster__limb--fl {
                        clip-path: polygon(0 0,100% 0,70% 80%,60% 100%,0% 100%,40% 80%);
                        top: 2em;
                        left: 0.5em;
                        width: 1em;
                        height: 1.5em;
                        transform-origin: 50% 0;

        }

                .hamster__limb--fr {
                        animation: hamsterFRLimb var(--dur) linear infinite;
                        background: linear-gradient(hsl(30,90%,80%) 80%,hsl(0,90%,75%) 80%);
                        transform: rotate(15deg) translateZ(-1px);

        }

                .hamster__limb--fl {
                        animation: hamsterFLLimb var(--dur) linear infinite;
                        background: linear-gradient(hsl(30,90%,90%) 80%,hsl(0,90%,85%) 80%);
                        transform: rotate(15deg);

        }

                .hamster__limb--br,
                .hamster__limb--bl {
                        border-radius: 0.75em 0.75em 0 0;
                        clip-path: polygon(0 0,100% 0,100% 30%,70% 90%,70% 100%,30% 100%,40% 90%,0% 30%);
                        top: 1em;
                        left: 2.8em;
                        width: 1.5em;
                        height: 2.5em;
                        transform-origin: 50% 30%;

        }

                .hamster__limb--br {
                        animation: hamsterBRLimb var(--dur) linear infinite;
                        background: linear-gradient(hsl(30,90%,80%) 90%,hsl(0,90%,75%) 90%);
                        transform: rotate(-25deg) translateZ(-1px);

        }

                .hamster__limb--bl {
                        animation: hamsterBLLimb var(--dur) linear infinite;
                        background: linear-gradient(hsl(30,90%,90%) 90%,hsl(0,90%,85%) 90%);
                        transform: rotate(-25deg);

        }

                .hamster__tail {
                        animation: hamsterTail var(--dur) linear infinite;
                        background: hsl(0,90%,85%);
                        border-radius: 0.25em 50% 50% 0.25em;
                        box-shadow: 0 -0.2em 0 hsl(0,90%,75%) inset;
                        top: 1.5em;
                        right: -0.5em;
                        width: 1em;
                        height: 0.5em;
                        transform: rotate(30deg) translateZ(-1px);
                        transform-origin: 0.25em 0.25em;

        }

                .spoke {
                        animation: spoke var(--dur) linear infinite;
                        background: radial-gradient(100% 100% at center,hsl(0,0%,60%) 4.8%,hsla(0,0%,60%,0) 5%), linear-gradient(hsla(0,0%,55%,0) 46.9%,hsl(0,0%,65%) 47% 52.9%,hsla(0,0%,65%,0) 53%) 50% 50% / 99% 99% no-repeat;

        }


        /* Animations */
                @@keyframes hamster {
                        from, to

        {
                            transform: rotate(4deg) translate(-0.8em,1.85em);

        }

                    50% {
                            transform: rotate(0) translate(-0.8em,1.85em);

        }


        }

                @@keyframes hamsterHead {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(0);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(8deg);

        }


        }

                @@keyframes hamsterEye {
                        from, 90%, to

        {
                            transform: scaleY(1);

        }

                    95% {
                            transform: scaleY(0);

        }


        }

                @@keyframes hamsterEar {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(0);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(12deg);

        }


        }

                @@keyframes hamsterBody {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(0);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(-2deg);

        }


        }

                @@keyframes hamsterFRLimb {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(50deg) translateZ(-1px);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(-30deg) translateZ(-1px);

        }


        }

                @@keyframes hamsterFLLimb {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(-30deg);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(50deg);

        }


        }

                @@keyframes hamsterBRLimb {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(-60deg) translateZ(-1px);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(20deg) translateZ(-1px);

        }


        }

                @@keyframes hamsterBLLimb {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(20deg);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(-60deg);

        }


        }

                @@keyframes hamsterTail {
                        from, 25%, 50%, 75%, to

        {
                            transform: rotate(30deg) translateZ(-1px);

        }

                    12.5%, 37.5%, 62.5%, 87.5% {
                            transform: rotate(10deg) translateZ(-1px);

        }


        }

                @@keyframes spoke {
                        from

        {
                            transform: rotate(0);

        }

                    to {
                            transform: rotate(-1turn);

        }


        }

        /* ---------- end hamster CSS ---------- */

    </style>
}

<h2 class="mb-4">Chỉnh sửa phòng @Model.RoomNumber</h2>

<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="wheel-and-hamster" role="img" aria-label="Loading">
        <div class="wheel"></div>
        <div class="hamster">
            <div class="hamster__body">
                <div class="hamster__head">
                    <div class="hamster__ear"></div>
                    <div class="hamster__eye"></div>
                    <div class="hamster__nose"></div>
                </div>
                <div class="hamster__limb hamster__limb--fr"></div>
                <div class="hamster__limb hamster__limb--fl"></div>
                <div class="hamster__limb hamster__limb--br"></div>
                <div class="hamster__limb hamster__limb--bl"></div>
                <div class="hamster__tail"></div>
            </div>
        </div>
        <div class="spoke"></div>
    </div>
</div>

<form asp-action="EditRoom" asp-controller="Admin" method="post" enctype="multipart/form-data" id="editRoomForm">
    <input type="hidden" asp-for="RoomId" />

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Thông tin cơ bản</h4></div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="RoomTypeId" class="form-label"></label>
                    <select asp-for="RoomTypeId" asp-items="@(new SelectList(Model.AllRoomTypes, "RoomTypeId", "TypeName"))" class="form-select">
                        <option value="">-- Chọn loại phòng --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="RoomNumber" class="form-label"></label>
                    <input asp-for="RoomNumber" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label asp-for="Floor" class="form-label"></label>
                    <input asp-for="Floor" class="form-control" />
                </div>
                <div class="col-12">
                    <label asp-for="PricePerNight" class="form-label"></label>
                    <div class="input-group">
                        <input asp-for="PricePerNight" class="form-control" />
                        <span class="input-group-text">VND</span>
                    </div>
                </div>
                <div class="col-12">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Quản lý tiện ích</h4></div>
        <div class="card-body">
            <h5>Danh sách tiện ích hiện có</h5>
            <table class="table table-hover align-middle">
                <tbody id="amenityList">
                    @foreach (var amenity in Model.CurrentAmenities)
                    {
                        <tr data-id="@amenity.Id">
                            <td><i class="bi @amenity.Icon me-2"></i>@amenity.Name</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-outline-danger btn-sm btn-delete-amenity" data-id="@amenity.Id">
                                    <i class="bi bi-trash-fill"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <hr>
            <h5>Thêm tiện ích mới</h5>
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="dropdownAddAmenity" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle-fill me-2"></i> Chọn tiện ích để thêm
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownAddAmenity" id="newAmenityDropdown">
                    @foreach (var amenity in Model.AllAvailableAmenities)
                    {
                        <li>
                            <a class="dropdown-item" href="#" data-id="@amenity.Id" data-name="@amenity.Name" data-icon="@amenity.Icon">
                                <i class="bi @amenity.Icon me-2"></i>@amenity.Name
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Quản lý hình ảnh (Ảnh phụ)</h4></div>
        <div class="card-body">
            <h5>Danh sách hình ảnh</h5>
            <div class="row g-3" id="imageListContainer">
                @foreach (var image in Model.CurrentImages)
                {
                    <div class="col-6 col-md-4 col-lg-3" data-id="@image.Id">
                        <div class="image-thumbnail-container">

                            <img src="@image.Url" alt="Ảnh phòng @Model.RoomNumber">
                            <button type="button" class="btn btn-danger btn-sm rounded-circle btn-delete-image" data-id="@image.Id">
                                <i class="bi bi-x-lg"></i>
                            </button>

                        </div>
                    </div>
                }
            </div>
            <hr>
            <h5>Thêm ảnh mới</h5>
            <div class="mb-3">
                <label for="imageUpload" class="form-label">Chọn một hoặc nhiều ảnh để tải lên:</label>
                <input class="form-control" type="file" id="imageUpload" asp-for="NewImages" multiple accept="image/*">
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Ảnh đại diện phòng @Model.RoomNumber</h4></div>
        <div class="card-body">
            <h5>Xem trước ảnh</h5>
            <div class="row g-3 align-items-center">
                <div class="col-md-4 col-lg-3">
                    <div class="image-thumbnail-container">
                        <img src="@(Model.AvatarRoomRecive)"
                             alt="Avatar phòng @Model.RoomNumber"
                             id="avatarPreview"
                             onerror="this.onerror=null; this.src='/images/placeholder-avatar.jpg';">
                    </div>
                </div>
                <div class="col-md-8 col-lg-9">
                    <label for="avatarUpload" class="form-label">Chọn/Thay đổi ảnh đại diện:</label>
                    <input class="form-control" type="file" id="avatarUpload" asp-for="AvatarRoom" accept="image/*">
                    <small class="text-muted mt-1 d-block">Chọn ảnh mới để thay thế ảnh đại diện hiện tại.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="text-end">
        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
            <i class="bi bi-save-fill me-2"></i> Lưu thay đổi
        </button>
    </div>



</form>

<div id="successToast" class="toast-top-right">Cập nhật thành công</div>
<div id="errorToast" class="toast-top-right">Cập nhật thất bại</div>

@section Scripts {
    <script>
        const amenityList = document.getElementById('amenityList');
        const newAmenityDropdown = document.getElementById('newAmenityDropdown');
        const imageListContainer = document.getElementById('imageListContainer');
        const imageUpload = document.getElementById('imageUpload');

        // --- Phần tử Avatar mới ---
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        // ---

        const editRoomForm = document.getElementById('editRoomForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const submitBtn = document.getElementById('submitBtn');
        let deletedImageIds = [];

        function showToast(message) {
            const toast = document.getElementById('successToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('active');
                loadingOverlay.setAttribute('aria-hidden', 'false');
            }
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.setAttribute('aria-disabled', 'true');
            }
        }

        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
                loadingOverlay.setAttribute('aria-hidden', 'true');
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.removeAttribute('aria-disabled');
            }
        }

        newAmenityDropdown.addEventListener('click', function(e) {
            if (e.target.matches('a.dropdown-item')) {
                e.preventDefault();
                const amenityId = e.target.dataset.id;
                const itemName = e.target.dataset.name;
                const itemIcon = e.target.dataset.icon;

                const newRow = document.createElement('tr');
                newRow.dataset.id = amenityId;
                newRow.innerHTML = `
                    <td><i class="bi ${itemIcon} me-2"></i>${itemName}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm btn-delete-amenity" data-id="${amenityId}">
                            <i class="bi bi-trash-fill"></i> Xóa
                        </button>
                    </td>
                `;
                amenityList.appendChild(newRow);
                e.target.closest('li').style.display = 'none';
            }
        });

        amenityList.addEventListener('click', function(e) {
            const deleteButton = e.target.closest('.btn-delete-amenity');
            if (deleteButton) {
                const row = deleteButton.closest('tr');
                const amenityId = row.dataset.id;
                const dropdownItem = newAmenityDropdown.querySelector(`a[data-id="${amenityId}"]`);
                if (dropdownItem) dropdownItem.closest('li').style.display = 'block';
                row.remove();
            }
        });

        imageUpload.addEventListener('change', function(e) {
            if (e.target.files) {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newImageCol = document.createElement('div');
                        newImageCol.className = 'col-6 col-md-4 col-lg-3';
                        newImageCol.innerHTML = `
                            <div class="image-thumbnail-container">
                                <img src="${event.target.result}" alt="Ảnh mới">
                                <button type="button" class="btn btn-danger btn-sm rounded-circle btn-delete-image">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        `;
                        imageListContainer.appendChild(newImageCol);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        imageListContainer.addEventListener('click', function(e) {
            const deleteButton = e.target.closest('.btn-delete-image');
            if (deleteButton) {
                const imageContainer = deleteButton.closest('.col-6');
                const imageId = imageContainer ? imageContainer.dataset.id : null;
                if (imageId) deletedImageIds.push(imageId);
                if (imageContainer) imageContainer.remove();
            }
        });

        // --- Logic cho Avatar (Chỉ tải lên và xem trước) ---
        avatarUpload.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    avatarPreview.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        editRoomForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            // 1. Thêm ảnh mới (ảnh phụ)
            if (imageUpload.files) {
                Array.from(imageUpload.files).forEach(file => formData.append('NewImages', file));
            }

            // 2. AvatarRoom đã được bind tự động thông qua asp-for nếu có file.

            // 3. Xử lý Amenity
            const amenityRows = amenityList.querySelectorAll('tr');
            const currentAmenityIds = Array.from(amenityRows).map(r => r.dataset.id);
            const allCurrentIds = @Html.Raw(Json.Serialize(Model.CurrentAmenities.Select(a => a.Id)));

            allCurrentIds.filter(id => !currentAmenityIds.includes(id.toString()))
                         .forEach(id => formData.append('DeletedAmenity', id));

            currentAmenityIds.filter(id => !allCurrentIds.includes(parseInt(id)))
                             .forEach(id => formData.append('NewAmenities', id));

            // 4. Xử lý Image (Ảnh phụ)
            deletedImageIds.forEach(id => formData.append('DeletedImageIds', id));

            const roomId = document.querySelector('[name="RoomId"]').value;

            // Show loading overlay before sending
            showLoading();

            fetch(`/admin/room/${roomId}`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                // Hide loading when response arrives
                hideLoading();

                if (data.success) {
                    showToast('Cập nhật thành công');
                    // Cập nhật lại URL ảnh Avatar sau khi lưu thành công (nếu server trả về)
                    if (data.newAvatarUrl) {
                        avatarPreview.src = data.newAvatarUrl;
                    }

                    // Reset trạng thái
                    deletedImageIds = [];
                    imageUpload.value = '';
                    avatarUpload.value = '';

                } else {
                    showError(data.message || 'Cập nhật thất bại');
                }
            })
            .catch(err => {
                console.error(err);
                hideLoading();
                showError('Lỗi khi gửi dữ liệu.');
            });
        });

        editRoomForm.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // ngăn form submit mặc định
                editRoomForm.dispatchEvent(new Event('submit')); // trigger fetch submit
            }
        });
    </script>
}