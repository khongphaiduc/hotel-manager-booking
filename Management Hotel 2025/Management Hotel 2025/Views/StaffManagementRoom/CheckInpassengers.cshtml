@model Mydata.Models.Booking

@{
    Layout = null;
    ViewBag.Step = 1;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Check-in - Khách sạn 5 sao (Full Width & Height)</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        body {
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(180deg, #f3f6fb 0%, #ffffff 100%);
            overflow: hidden;
        }

        .app-shell {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            flex: 0 0 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(4px);
        }

            .topbar .title {
                font-weight: 700;
                font-size: 1.35rem;
                color: #0d6efd;
                margin-right: 12px;
            }

        .main {
            flex: 1 1 auto;
            display: flex;
            gap: 14px;
            padding: 14px;
            box-sizing: border-box;
            align-items: stretch;
            width: 100%;
        }

        .col {
            display: flex;
            flex-direction: column;
            flex: 1 1 50%;
            min-width: 0;
        }

        .card {
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 0;
            box-shadow: 0 8px 26px rgba(18,38,63,0.07);
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px 16px 26px;
            background-color: #fbfdff;
            font-size: 1.18rem;
            font-weight: 700;
            color: #07204a;
            border-bottom: 1px solid rgba(7,32,74,0.06);
            position: relative;
        }

            .card-header::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 6px;
                background: linear-gradient(180deg, #0d6efd 0%, #5aa0ff 100%);
            }

        .card-body {
            padding: 16px;
            overflow-y: auto;
        }

        .form-control, .form-select, textarea {
            min-height: 42px;
        }

        /* Nút cố định ở góc trái màn hình */
        .fixed-actions {
            position: fixed;
            bottom: 20px;
            right: 20px; /* ✅ chuyển từ left: 20px -> right: 20px */
            z-index: 1050;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(6px);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 14px;
        }



        .section-label {
            font-weight: 600;
            color: #0b2a66;
            font-size: 0.95rem;
        }

        @@media (max-width: 991.98px) {
            .main {
                flex-direction: column;
                padding: 10px;
            }

            .col {
                flex: 1 1 auto;
            }

            .topbar {
                flex: 0 0 56px;
            }
        }
    </style>
</head>

<body>
    @Html.Partial("_ProgressCheckInBar", (int)ViewBag.Step)

    <div class="app-shell">
        <div class="main">
            <!-- Guest Information -->
            <div class="col">
                <div class="card">
                    <div class="card-header"><strong>Thông tin khách</strong></div>
                    <div class="card-body">
                        <form id="guestForm" class="h-100">
                            <div class="mb-3">
                                <label for="fullName" class="form-label section-label">Họ tên khách <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="fullName" asp-for="CustomerName" value="@Model.CustomerName" placeholder="Tự động điền hoặc nhập tay" required>
                            </div>

                            <div class="mb-3">
                                <label for="idNumber" class="form-label section-label">Số CMND / Passport</label>
                                <input type="text" class="form-control" id="idNumber" asp-for="PersonalCode" value="@Model.PersonalCode" placeholder="Số CMND hoặc Passport">
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="nationality" class="form-label section-label">Quốc tịch</label>
                                    <input type="text" class="form-control" id="nationality" asp-for="Nationality" value="@Model.Nationality" placeholder="VD: Việt Nam">
                                </div>
                                <div class="col-6">
                                    <label for="dob" class="form-label section-label">Ngày sinh</label>
                                    <input type="date" class="form-control" id="dob" asp-for="BirthDay" max="2100-12-31">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="form-label section-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="phone" asp-for="CustomerPhone" value="@Model.CustomerPhone" placeholder="+84 9xx xxx xxx">
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label section-label">Email</label>
                                <input type="email" class="form-control" value="@Model.Email" id="email" asp-for="Email" placeholder="email@domain.com">
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label section-label">Địa chỉ</label>
                                <textarea class="form-control" id="address" asp-for="Address" rows="3" placeholder="Địa chỉ để xuất hóa đơn / hồ sơ">@Model.Address</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="guestType" class="form-label section-label">Loại khách</label>
                                <select class="form-select" id="guestType" asp-for="TypePassenger">
                                    <option value="Personal" selected="@(Model.TypePassenger == "Personal" ? "selected" : null)">Cá Nhân</option>
                                    <option value="Company" selected="@(Model.TypePassenger == "Company" ? "selected" : null)">Công ty</option>
                                    <option value="Tour" selected="@(Model.TypePassenger == "Tour" ? "selected" : null)">Tour</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Booking Details -->
            <div class="col">
                <div class="card">
                    <div class="card-header"><strong>Thông tin đặt phòng</strong></div>
                    <div class="card-body">
                        <form id="checkinForm" novalidate>
                            <div class="mb-3">
                                <label for="roomNumber" class="form-label section-label">Mã Booking</label>
                                <input class="form-select" id="roomNumber" disabled value="@Model.BookingCode" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label section-label">Danh sách phòng</label>
                                <input class="form-select" id="roomList" disabled />
                            </div>

                            <div class="mb-3">
                                <label for="numGuests" class="form-label section-label">Số người</label>
                                <input type="number" class="form-control" id="numGuests" name="numGuests" value="1" min="1" max="10">
                            </div>

                            <div class="row g-3 mb-3">
                                @{
                                    var first = Model.BookingDetails?.FirstOrDefault();
                                    string checkInValue = first?.CheckInDate?.ToString("yyyy-MM-dd") ?? "";
                                    string checkOutValue = first?.CheckOutDate?.ToString("yyyy-MM-dd") ?? "";
                                }

                                <div class="col-6">
                                    <label for="checkinDate" class="form-label section-label">Ngày check-in dự kiến</label>
                                    <input type="date" class="form-control" id="checkinDate" value="@checkInValue" disabled />
                                </div>

                                <div class="col-6">
                                    <label for="checkoutDate" class="form-label section-label">Ngày check-out dự kiến</label>
                                    <input type="date" class="form-control" id="checkoutDate" value="@checkOutValue" disabled />
                                </div>
                            </div>

                            <div id="formAlert" class="mt-3" style="display:none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nút hành động cố định -->
    <div class="fixed-actions">
        <button type="button" class="btn btn-success" id="btnSave">Xác nhận nhận phòng</button>
        <button type="button" class="btn btn-secondary" id="btnReset">Hủy / Làm lại</button>
    </div>

    <!-- Bootstrap JS + Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        (function () {
            const guestForm = document.getElementById("guestForm");
            const checkinForm = document.getElementById("checkinForm");
            const btnSave = document.getElementById("btnSave");
            const btnReset = document.getElementById("btnReset");
            const formAlert = document.getElementById("formAlert");

            const fullNameEl = document.getElementById("fullName");
            const idNumberEl = document.getElementById("idNumber");
            const nationalityEl = document.getElementById("nationality");
            const dobEl = document.getElementById("dob");
            const phoneEl = document.getElementById("phone");
            const emailEl = document.getElementById("email");
            const addressEl = document.getElementById("address");
            const guestTypeEl = document.getElementById("guestType");
            const checkinDateEl = document.getElementById("checkinDate");
            const checkoutDateEl = document.getElementById("checkoutDate");

            btnSave.addEventListener("click", async (e) => {
                e.preventDefault();
                clearAlert();

                if (!guestForm.checkValidity()) {
                    guestForm.classList.add("was-validated");
                    showAlert("danger", "Vui lòng nhập đầy đủ thông tin khách hàng hợp lệ.");
                    return;
                }

                const payload = {
                    BookingCode: document.getElementById("roomNumber").value,
                    CustomerName: fullNameEl.value.trim(),
                    PersonalCode: idNumberEl.value.trim(),
                    Nationality: nationalityEl.value.trim(),
                    BirthDay: dobEl.value,
                    CustomerPhone: phoneEl.value.trim(),
                    Email: emailEl.value.trim(),
                    Address: addressEl.value.trim(),
                    TypePassenger: guestTypeEl.value,
                    CheckInDate: checkinDateEl.value,
                    CheckOutDate: checkoutDateEl.value
                };

                try {
                    const response = await fetch('/StaffManagementRoom/CheckInPassengers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert("success", result.message);
                        guestForm.reset();
                        checkinForm.reset();
                        guestForm.classList.remove("was-validated");
                        checkinForm.classList.remove("was-validated");
                         // chuyển sang trang thứ 2
                        window.location.href = `/StaffManagementRoom/RegisterGuestInfo?bookingcode=${encodeURIComponent(payload.BookingCode)}`;

                    } else {
                        showAlert("danger", result.message);
                    }
                } catch (err) {
                    console.error(err);
                    showAlert("danger", "Đã có lỗi xảy ra khi check-in. Vui lòng thử lại.");
                }
            });

            btnReset.addEventListener("click", () => {
                guestForm.reset();
                checkinForm.reset();
                guestForm.classList.remove("was-validated");
                checkinForm.classList.remove("was-validated");
                clearAlert();
            });

            function showAlert(kind, message) {
                clearAlert();
                const wrapper = document.createElement("div");
                wrapper.className = `alert alert-${kind}`;
                wrapper.role = "alert";
                wrapper.innerHTML = message;
                formAlert.style.display = "block";
                formAlert.appendChild(wrapper);
                if (kind === "success") {
                    setTimeout(() => clearAlert(), 4000);
                }
            }

            function clearAlert() {
                formAlert.style.display = "none";
                formAlert.innerHTML = "";
            }
        })();
    </script>
</body>
</html>
