@model Management_Hotel_2025.ViewModel.AdJustRoom

@{
    Layout = "~/Views/Shared/AdminSidebar.cshtml";
    ViewData["Title"] = "Chỉnh sửa phòng";
}

@section Styles {
    <style>
        .image-thumbnail-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
            overflow: hidden;
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
        }

            .image-thumbnail-container img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .btn-delete-image {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.7);
        }

        /* Toast góc phải trên */
        .toast-top-right {
            position: fixed;
            top: 1rem;
            right: -300px; /* bắt đầu bên ngoài màn hình */
            background-color: #28a745;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1050;
            opacity: 0;
            transition: right 0.5s ease, opacity 0.5s ease;
        }

            .toast-top-right.show {
                right: 1rem; /* trượt vào */
                opacity: 1;
            }
    </style>
}

<h2 class="mb-4">Chỉnh sửa phòng @Model.RoomNumber</h2>

<form asp-action="EditRoom" asp-controller="Admin" method="post" enctype="multipart/form-data" id="editRoomForm">
    <input type="hidden" asp-for="RoomId" />

    <!-- Thông tin cơ bản -->
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Thông tin cơ bản</h4></div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="RoomTypeId" class="form-label"></label>
                    <select asp-for="RoomTypeId" asp-items="@(new SelectList(Model.AllRoomTypes, "RoomTypeId", "TypeName"))" class="form-select">
                        <option value="">-- Chọn loại phòng --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="RoomNumber" class="form-label"></label>
                    <input asp-for="RoomNumber" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label asp-for="Floor" class="form-label"></label>
                    <input asp-for="Floor" class="form-control" />
                </div>
                <div class="col-12">
                    <label asp-for="PricePerNight" class="form-label"></label>
                    <div class="input-group">
                        <input asp-for="PricePerNight" class="form-control" />
                        <span class="input-group-text">VND</span>
                    </div>
                </div>
                <div class="col-12">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Quản lý tiện ích -->
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Quản lý tiện ích</h4></div>
        <div class="card-body">
            <h5>Danh sách tiện ích hiện có</h5>
            <table class="table table-hover align-middle">
                <tbody id="amenityList">
                    @foreach (var amenity in Model.CurrentAmenities)
                    {
                        <tr data-id="@amenity.Id">
                            <td><i class="bi @amenity.Icon me-2"></i>@amenity.Name</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-outline-danger btn-sm btn-delete-amenity" data-id="@amenity.Id">
                                    <i class="bi bi-trash-fill"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <hr>
            <h5>Thêm tiện ích mới</h5>
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="dropdownAddAmenity" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle-fill me-2"></i> Chọn tiện ích để thêm
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownAddAmenity" id="newAmenityDropdown">
                    @foreach (var amenity in Model.AllAvailableAmenities)
                    {
                        if (!Model.CurrentAmenities.Any(a => a.Id == amenity.Id))
                        {
                            <li>
                                <a class="dropdown-item" href="#" data-id="@amenity.Id" data-name="@amenity.Name" data-icon="@amenity.Icon">
                                    <i class="bi @amenity.Icon me-2"></i>@amenity.Name
                                </a>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>

    <!-- Quản lý hình ảnh -->
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h4 class="mb-0">Quản lý hình ảnh</h4></div>
        <div class="card-body">
            <h5>Danh sách hình ảnh</h5>
            <div class="row g-3" id="imageListContainer">
                @foreach (var image in Model.CurrentImages)
                {
                    <div class="col-6 col-md-4 col-lg-3" data-id="@image.Id">
                        <div class="image-thumbnail-container">
                            <img src="@image.Url" alt="Ảnh phòng @Model.RoomNumber">
                            <button type="button" class="btn btn-danger btn-sm rounded-circle btn-delete-image" data-id="@image.Id">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
            <hr>
            <h5>Thêm ảnh mới</h5>
            <div class="mb-3">
                <label for="imageUpload" class="form-label">Chọn một hoặc nhiều ảnh để tải lên:</label>
                <input class="form-control" type="file" id="imageUpload" asp-for="NewImages" multiple accept="image/*">
            </div>
        </div>
    </div>

    <div class="text-end">
        <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="bi bi-save-fill me-2"></i> Lưu thay đổi
        </button>
    </div>
</form>

<!-- Toast góc phải trên -->
<div id="successToast" class="toast-top-right">
    Cập nhật thành công
</div>

@section Scripts {
    <script>
        const amenityList = document.getElementById('amenityList');
        const newAmenityDropdown = document.getElementById('newAmenityDropdown');
        const imageListContainer = document.getElementById('imageListContainer');
        const imageUpload = document.getElementById('imageUpload');
        const editRoomForm = document.getElementById('editRoomForm');
        let deletedImageIds = [];

        function showToast(message) {
            const toast = document.getElementById('successToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000); // 2 giây
        }

        // Thêm tiện ích mới
        newAmenityDropdown.addEventListener('click', function(e) {
            if (e.target.matches('a.dropdown-item')) {
                e.preventDefault();
                const amenityId = e.target.dataset.id;
                const itemName = e.target.dataset.name;
                const itemIcon = e.target.dataset.icon;

                const newRow = document.createElement('tr');
                newRow.dataset.id = amenityId;
                newRow.innerHTML = `
                    <td><i class="bi ${itemIcon} me-2"></i>${itemName}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm btn-delete-amenity" data-id="${amenityId}">
                            <i class="bi bi-trash-fill"></i> Xóa
                        </button>
                    </td>
                `;
                amenityList.appendChild(newRow);
                e.target.closest('li').style.display = 'none';
            }
        });

        // Xóa tiện ích
        amenityList.addEventListener('click', function(e) {
            const deleteButton = e.target.closest('.btn-delete-amenity');
            if (deleteButton) {
                const row = deleteButton.closest('tr');
                const amenityId = row.dataset.id;
                const dropdownItem = newAmenityDropdown.querySelector(`a[data-id="${amenityId}"]`);
                if (dropdownItem) dropdownItem.closest('li').style.display = 'block';
                row.remove();
            }
        });

        // Thêm ảnh mới preview
        imageUpload.addEventListener('change', function(e) {
            if (e.target.files) {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newImageCol = document.createElement('div');
                        newImageCol.className = 'col-6 col-md-4 col-lg-3';
                        newImageCol.innerHTML = `
                            <div class="image-thumbnail-container">
                                <img src="${event.target.result}" alt="Ảnh mới">
                                <button type="button" class="btn btn-danger btn-sm rounded-circle btn-delete-image">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        `;
                        imageListContainer.appendChild(newImageCol);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });

        // Xóa ảnh
        imageListContainer.addEventListener('click', function(e) {
            const deleteButton = e.target.closest('.btn-delete-image');
            if (deleteButton) {
                const imageContainer = deleteButton.closest('.col-6');
                const imageId = imageContainer.dataset.id;
                if (imageId) deletedImageIds.push(imageId);
                imageContainer.remove();
            }
        });

        // Submit form bằng fetch
        editRoomForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            // Thêm file mới
            if (imageUpload.files) {
                Array.from(imageUpload.files).forEach(file => formData.append('NewImages', file));
            }

            // Amenity
            const amenityRows = amenityList.querySelectorAll('tr');
            const currentAmenityIds = Array.from(amenityRows).map(r => r.dataset.id);
            const allCurrentIds = @Html.Raw(Json.Serialize(Model.CurrentAmenities.Select(a => a.Id)));

            // Deleted
            allCurrentIds.filter(id => !currentAmenityIds.includes(id.toString()))
                         .forEach(id => formData.append('DeletedAmenity', id));

            // New
            currentAmenityIds.filter(id => !allCurrentIds.includes(parseInt(id)))
                             .forEach(id => formData.append('NewAmenities', id));

            // Deleted Images
            deletedImageIds.forEach(id => formData.append('DeletedImageIds', id));

            const roomId = document.querySelector('[name="RoomId"]').value;

            fetch(`/admin/room/${roomId}`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Cập nhật thành công');
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Lỗi khi gửi dữ liệu.');
            });
        });
    </script>
}
